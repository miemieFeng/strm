<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebDAVç›‘æ§å™¨</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <style>
        body {
            padding-top: 20px;
            background-color: #f5f5f5;
        }
        .card {
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            background-color: #f8f9fa;
            font-weight: bold;
            border-bottom: 1px solid #dee2e6;
        }
        .log-entry {
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        .log-INFO {
            background-color: #e8f4f8;
        }
        .log-WARNING {
            background-color: #fff3cd;
        }
        .log-ERROR {
            background-color: #f8d7da;
        }
        .status-running {
            color: #198754;
            font-weight: bold;
        }
        .status-stopped {
            color: #dc3545;
            font-weight: bold;
        }
        .btn-group {
            margin-bottom: 20px;
        }
        .navbar-brand {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .stats-value {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .form-password {
            position: relative;
        }
        .toggle-password {
            position: absolute;
            right: 10px;
            top: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="d-flex flex-wrap justify-content-center py-3 mb-4 border-bottom">
            <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-dark text-decoration-none">
                <span class="navbar-brand">WebDAVç›‘æ§å™¨</span>
            </a>
            <ul class="nav nav-pills">
                <li class="nav-item"><span class="nav-link {{ 'active' if stats.status == 'è¿è¡Œä¸­' else '' }}">çŠ¶æ€: 
                    <span class="{{ 'status-running' if stats.status == 'è¿è¡Œä¸­' else 'status-stopped' }}">{{ stats.status }}</span>
                </span></li>
            </ul>
        </header>

        <!-- æ§åˆ¶æŒ‰é’® -->
        <div class="row">
            <div class="col-md-12">
                <div class="btn-group" role="group">
                    <button id="btnStart" class="btn btn-success" {{ 'disabled' if stats.status == 'è¿è¡Œä¸­' else '' }}>å¯åŠ¨ç›‘æ§</button>
                    <button id="btnStop" class="btn btn-danger" {{ 'disabled' if stats.status != 'è¿è¡Œä¸­' else '' }}>åœæ­¢ç›‘æ§</button>
                    <button id="btnRestart" class="btn btn-warning">é‡å¯ç›‘æ§</button>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- å·¦ä¾§ï¼šçŠ¶æ€å’Œæ—¥å¿— -->
            <div class="col-md-7">
                <!-- çŠ¶æ€å¡ç‰‡ -->
                <div class="card">
                    <div class="card-header">
                        è¿è¡ŒçŠ¶æ€
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <p>çŠ¶æ€: <span class="{{ 'status-running' if stats.status == 'è¿è¡Œä¸­' else 'status-stopped' }}">{{ stats.status }}</span></p>
                                <p>ç›‘æ§é—´éš”: <span class="stats-value">{{ stats.interval }}ç§’</span></p>
                            </div>
                            <div class="col-md-8">
                                <p>æœ¬åœ°ç›®å½•: <span class="text-muted">{{ stats.local_dir }}</span></p>
                                <p>è¿œç¨‹ç›®å½•: <span class="text-muted">{{ stats.remote_dir }}</span></p>
                            </div>
                        </div>

                        <hr>

                        <div class="row">
                            <div class="col-md-4">
                                <p>ä¸‹è½½æ–‡ä»¶æ•°: <span class="stats-value">{{ stats.download_count|default(0) }}</span></p>
                            </div>
                            <div class="col-md-4">
                                <p>å¤„ç†STRM: <span class="stats-value">{{ stats.processed_count|default(0) }}</span></p>
                            </div>
                            <div class="col-md-4">
                                <p>å¤±è´¥æ•°: <span class="stats-value text-danger">{{ stats.error_count|default(0) }}</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æœ€è¿‘ä¸‹è½½æ–‡ä»¶å¡ç‰‡ -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        æœ€è¿‘ä¸‹è½½æ–‡ä»¶
                        <span id="refreshStatus" class="badge bg-secondary">è‡ªåŠ¨åˆ·æ–°</span>
                    </div>
                    <div class="card-body">
                        <div id="recentFiles" class="list-group">
                            <div class="text-center text-muted">åŠ è½½ä¸­...</div>
                        </div>
                    </div>
                </div>

                <!-- æ—¥å¿—å¡ç‰‡ -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        ç›‘æ§æ—¥å¿—
                        <button id="refreshLogs" class="btn btn-sm btn-outline-secondary">åˆ·æ–°</button>
                    </div>
                    <div class="card-body p-0">
                        <div id="logEntries" style="max-height: 300px; overflow-y: auto;">
                            {% if logs %}
                                {% for log in logs %}
                                    <div class="log-entry log-{{ log.level }}">
                                        <small class="text-muted">{{ log.time }}</small> 
                                        <span class="badge bg-{{ 'info' if log.level == 'INFO' else ('warning' if log.level == 'WARNING' else 'danger') }}">{{ log.level }}</span>
                                        {{ log.message }}
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center text-muted p-3">æ— æ—¥å¿—è®°å½•</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šé…ç½® -->
            <div class="col-md-5">
                <div class="card">
                    <div class="card-header">
                        WebDAVé…ç½®
                    </div>
                    <div class="card-body">
                        <form id="configForm">
                            <div class="mb-3">
                                <label for="webdav_url" class="form-label">WebDAVåœ°å€</label>
                                <input type="text" class="form-control" id="webdav_url" name="webdav_url" value="{{ config.webdav_url }}" required>
                            </div>
                            <div class="mb-3">
                                <label for="username" class="form-label">ç”¨æˆ·å</label>
                                <input type="text" class="form-control" id="username" name="username" value="{{ config.username }}" required>
                            </div>
                            <div class="mb-3 form-password">
                                <label for="password" class="form-label">å¯†ç </label>
                                <input type="password" class="form-control" id="password" name="password" value="{{ config.password }}" required>
                                <span class="toggle-password" onclick="togglePassword('password')">ğŸ‘ï¸</span>
                            </div>
                            <div class="mb-3">
                                <label for="local_dir" class="form-label">æœ¬åœ°ç›®å½•</label>
                                <input type="text" class="form-control" id="local_dir" name="local_dir" value="{{ config.local_dir }}" required>
                            </div>
                            <div class="mb-3">
                                <label for="remote_dir" class="form-label">è¿œç¨‹ç›®å½•</label>
                                <input type="text" class="form-control" id="remote_dir" name="remote_dir" value="{{ config.remote_dir }}" required>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="check_interval" class="form-label">æ£€æŸ¥é—´éš”(ç§’)</label>
                                        <input type="number" class="form-control" id="check_interval" name="check_interval" value="{{ config.check_interval }}" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="max_workers" class="form-label">ä¸‹è½½çº¿ç¨‹æ•°</label>
                                        <input type="number" class="form-control" id="max_workers" name="max_workers" value="{{ config.max_workers }}" required>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="replace_ip" class="form-label">æ›¿æ¢STRMä¸­çš„IPä¸ºåŸŸå</label>
                                <input type="text" class="form-control" id="replace_ip" name="replace_ip" value="{{ config.replace_ip }}" placeholder="ä¾‹å¦‚: example.com">
                            </div>

                            <div class="mb-3">
                                <label for="post_command" class="form-label">ä¸‹è½½åæ‰§è¡Œå‘½ä»¤</label>
                                <input type="text" class="form-control" id="post_command" name="post_command" value="{{ config.post_command }}" placeholder="å¯ä½¿ç”¨{local_path}å ä½ç¬¦">
                            </div>

                            <div class="mb-3">
                                <label for="web_port" class="form-label">Webç«¯å£</label>
                                <input type="number" class="form-control" id="web_port" name="web_port" value="{{ config.web_port }}" required>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">ä¿å­˜é…ç½®</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <footer class="py-3 my-4 border-top">
            <p class="text-center text-muted">WebDAVç›‘æ§å™¨ &copy; 2023</p>
        </footer>
    </div>

    <!-- æ¨¡æ€æ¡† -->
    <div class="modal fade" id="messageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">æç¤º</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modalBody">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                    <button type="button" class="btn btn-primary" id="modalAction" style="display: none;">ç¡®å®š</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // æ˜¾ç¤ºæ¶ˆæ¯æ¨¡æ€æ¡†
        function showMessage(title, message, actionText = null, actionCallback = null) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').textContent = message;
            
            const actionButton = document.getElementById('modalAction');
            if (actionText && actionCallback) {
                actionButton.textContent = actionText;
                actionButton.style.display = 'block';
                actionButton.onclick = actionCallback;
            } else {
                actionButton.style.display = 'none';
            }
            
            const modal = new bootstrap.Modal(document.getElementById('messageModal'));
            modal.show();
        }

        // åˆ‡æ¢å¯†ç å¯è§æ€§
        function togglePassword(fieldId) {
            const field = document.getElementById(fieldId);
            if (field.type === 'password') {
                field.type = 'text';
            } else {
                field.type = 'password';
            }
        }

        // åŠ è½½æœ€è¿‘æ–‡ä»¶
        function loadRecentFiles() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    const recentFilesDiv = document.getElementById('recentFiles');
                    if (data.recent_files && data.recent_files.length > 0) {
                        recentFilesDiv.innerHTML = '';
                        data.recent_files.forEach(file => {
                            const fileItem = document.createElement('div');
                            fileItem.className = 'list-group-item list-group-item-action small';
                            fileItem.textContent = file;
                            recentFilesDiv.appendChild(fileItem);
                        });
                    } else {
                        recentFilesDiv.innerHTML = '<div class="text-center text-muted">æš‚æ— ä¸‹è½½æ–‡ä»¶</div>';
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½æœ€è¿‘æ–‡ä»¶å¤±è´¥:', error);
                    document.getElementById('recentFiles').innerHTML = 
                        '<div class="text-center text-danger">åŠ è½½å¤±è´¥</div>';
                });
        }

        // åˆ·æ–°æ—¥å¿—
        function refreshLogs() {
            fetch('/api/logs')
                .then(response => response.json())
                .then(logs => {
                    const logEntriesDiv = document.getElementById('logEntries');
                    if (logs.length > 0) {
                        logEntriesDiv.innerHTML = '';
                        logs.forEach(log => {
                            const logEntry = document.createElement('div');
                            logEntry.className = `log-entry log-${log.level}`;
                            
                            const timeSpan = document.createElement('small');
                            timeSpan.className = 'text-muted';
                            timeSpan.textContent = log.time + ' ';
                            
                            const levelBadge = document.createElement('span');
                            levelBadge.className = `badge bg-${log.level === 'INFO' ? 'info' : (log.level === 'WARNING' ? 'warning' : 'danger')}`;
                            levelBadge.textContent = log.level + ' ';
                            
                            logEntry.appendChild(timeSpan);
                            logEntry.appendChild(levelBadge);
                            logEntry.appendChild(document.createTextNode(' ' + log.message));
                            
                            logEntriesDiv.appendChild(logEntry);
                        });
                    } else {
                        logEntriesDiv.innerHTML = '<div class="text-center text-muted p-3">æ— æ—¥å¿—è®°å½•</div>';
                    }
                })
                .catch(error => {
                    console.error('åˆ·æ–°æ—¥å¿—å¤±è´¥:', error);
                });
        }

        // äº‹ä»¶ç›‘å¬
        document.addEventListener('DOMContentLoaded', () => {
            // å¯åŠ¨æŒ‰é’®
            document.getElementById('btnStart').addEventListener('click', function() {
                fetch('/api/start', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showMessage('æˆåŠŸ', 'ç›‘æ§å·²å¯åŠ¨');
                            setTimeout(() => { location.reload(); }, 1000);
                        } else {
                            showMessage('é”™è¯¯', 'å¯åŠ¨ç›‘æ§å¤±è´¥');
                        }
                    })
                    .catch(error => {
                        showMessage('é”™è¯¯', 'å¯åŠ¨ç›‘æ§è¯·æ±‚å¤±è´¥');
                    });
            });

            // åœæ­¢æŒ‰é’®
            document.getElementById('btnStop').addEventListener('click', function() {
                fetch('/api/stop', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showMessage('æˆåŠŸ', 'ç›‘æ§å·²åœæ­¢');
                            setTimeout(() => { location.reload(); }, 1000);
                        } else {
                            showMessage('é”™è¯¯', 'åœæ­¢ç›‘æ§å¤±è´¥');
                        }
                    })
                    .catch(error => {
                        showMessage('é”™è¯¯', 'åœæ­¢ç›‘æ§è¯·æ±‚å¤±è´¥');
                    });
            });

            // é‡å¯æŒ‰é’®
            document.getElementById('btnRestart').addEventListener('click', function() {
                fetch('/api/restart', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showMessage('æˆåŠŸ', 'ç›‘æ§å·²é‡å¯');
                            setTimeout(() => { location.reload(); }, 1000);
                        } else {
                            showMessage('é”™è¯¯', 'é‡å¯ç›‘æ§å¤±è´¥');
                        }
                    })
                    .catch(error => {
                        showMessage('é”™è¯¯', 'é‡å¯ç›‘æ§è¯·æ±‚å¤±è´¥');
                    });
            });

            // é…ç½®è¡¨å•æäº¤
            document.getElementById('configForm').addEventListener('submit', function(event) {
                event.preventDefault();
                
                const formData = new FormData(this);
                
                fetch('/api/save_config', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (data.needs_restart) {
                            showMessage('é…ç½®å·²ä¿å­˜', 'é…ç½®å·²æ›´æ–°ï¼Œä½†éœ€è¦é‡å¯ç›‘æ§æ‰èƒ½ç”Ÿæ•ˆ', 'é‡å¯ç›‘æ§', () => {
                                fetch('/api/restart', { method: 'POST' })
                                    .then(() => { 
                                        setTimeout(() => { location.reload(); }, 1000);
                                    });
                            });
                        } else {
                            showMessage('æˆåŠŸ', 'é…ç½®å·²ä¿å­˜');
                        }
                    } else {
                        showMessage('é”™è¯¯', 'ä¿å­˜é…ç½®å¤±è´¥');
                    }
                })
                .catch(error => {
                    showMessage('é”™è¯¯', 'ä¿å­˜é…ç½®è¯·æ±‚å¤±è´¥');
                });
            });

            // åˆ·æ–°æ—¥å¿—æŒ‰é’®
            document.getElementById('refreshLogs').addEventListener('click', refreshLogs);

            // åˆå§‹åŠ è½½æœ€è¿‘æ–‡ä»¶å’Œå®šæ—¶åˆ·æ–°
            loadRecentFiles();
            setInterval(() => {
                if (document.getElementById('refreshStatus').textContent === 'è‡ªåŠ¨åˆ·æ–°') {
                    loadRecentFiles();
                }
            }, 5000);

            // è‡ªåŠ¨åˆ·æ–°å¼€å…³
            document.getElementById('refreshStatus').addEventListener('click', function() {
                if (this.textContent === 'è‡ªåŠ¨åˆ·æ–°') {
                    this.textContent = 'å·²æš‚åœ';
                    this.classList.remove('bg-secondary');
                    this.classList.add('bg-warning');
                } else {
                    this.textContent = 'è‡ªåŠ¨åˆ·æ–°';
                    this.classList.remove('bg-warning');
                    this.classList.add('bg-secondary');
                    loadRecentFiles(); // ç«‹å³åˆ·æ–°ä¸€æ¬¡
                }
            });
        });
    </script>
</body>
</html> 